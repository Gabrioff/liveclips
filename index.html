<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiveClips</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importante para que React funcione en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Estilos cr铆ticos para m贸vil */
        body { 
            background-color: #000; 
            color: white; 
            overflow: hidden; 
            overscroll-behavior: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Filtro para poner el coraz贸n de rojo */
        .filter-red { filter: invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%); }
        
        /* Animaci贸n de Notificaci贸n Toast */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-down { animation: slideDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        /* Ajuste para videos en grid */
        video { object-fit: cover; }

        /* Animaci贸n de "escribiendo" */
        @keyframes typing {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 1px;
            background-color: #38bdf8; /* cyan-400 */
            border-radius: 50%;
            animation: typing 1.5s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Asegura que los mensajes antiguos se vean */
        .message-list-container {
            display: flex;
            flex-direction: column-reverse; /* Hace que los nuevos mensajes aparezcan abajo */
            overflow-y: auto;
            flex: 1;
            padding: 0 1rem; /* Padding horizontal */
        }
        .message-list-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
            padding-top: 1rem; /* p-4 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Music2, Home, Search, Loader2, AlertTriangle, Copy, Play, Pause, 
            User as UserIcon, Hash, Bell, ArrowLeft, Edit3, Camera, Check, X, 
            LogOut, Lock, UserPlus, UserCheck, Send, MessageCircle, FileText, Mic, Image
        } from 'https://esm.sh/lucide-react@0.344.0';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            onAuthStateChanged, signOut, updateProfile
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, addDoc, getDoc, setDoc, 
            updateDoc, increment, query, orderBy, deleteDoc, where, limit, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACIN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCqOTWcQ4uOC851_-j4JBUcENkCa-9xWdE",
            authDomain: "liveclips-93af8.firebaseapp.com",
            projectId: "liveclips-93af8",
            storageBucket: "liveclips-93af8.firebasestorage.app",
            messagingSenderId: "1075447494440",
            appId: "1:1075447494440:web:471562928542e95839021d",
            measurementId: "G-0ZC5V02V76"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'tiktok-glass-universal';

        // --- TUS ICONOS ORIGINALES ---
        const ICONS = {
            bandeja: "https://img.icons8.com/?size=100&id=JKQ8C03mfHVD&format=png&color=000000",
            perfil: "https://img.icons8.com/?size=100&id=AaFA8C8mpiZY&format=png&color=000000",
            corazon: "https://img.icons8.com/?size=100&id=sSZiheZL0ozl&format=png&color=000000",
            tendencia: "https://img.icons8.com/?size=100&id=g8O1NN7oS0KJ&format=png&color=000000",
            compartir: "https://img.icons8.com/?size=100&id=Wv2O2Ve44Are&format=png&color=000000",
            crear: "https://img.icons8.com/?size=100&id=rrOG2bhnvx0w&format=png&color=000000" 
        };

        // --- FUNCION PARA SUBIR ARCHIVOS A GITHUB ---
        const uploadToGitHub = async (file, path, setStatus) => {
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'github');
            const configSnap = await getDoc(configRef);
            if (!configSnap.exists()) throw new Error("Falta configuraci贸n GitHub");
            const { token, owner, repo } = configSnap.data();
            setStatus && setStatus("Procesando...");
            const toBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
            });
            const content = await toBase64(file);
            setStatus && setStatus("Subiendo...");
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Upload ${path}`, content: content, encoding: 'base64' })
            });
            if (!response.ok) {
                const errorBody = await response.json();
                 throw new Error(`Error GitHub: ${errorBody.message || response.statusText}`);
            }
            return `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
        };

        const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

        // --- COMPONENTE NOTIFICACIN TOAST ---
        const ToastNotification = ({ notif, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, []);

            if (!notif) return null;

            return (
                <div className="fixed top-4 left-4 right-4 z-[100] animate-slide-down">
                    <div className="bg-gray-800/90 backdrop-blur-md border border-gray-700 p-3 rounded-2xl shadow-2xl flex items-center gap-3" onClick={onClose}>
                        <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden flex-shrink-0 border border-gray-600">
                            <img src={notif.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${notif.fromUser}`} className="w-full h-full object-cover" />
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-white truncate">{notif.fromName}</p>
                            <p className="text-xs text-gray-300 truncate">
                                {notif.type === 'message' ? 'Te envi贸 un mensaje' : 
                                 notif.type === 'like' ? 'Le gust贸 tu video' : 
                                 notif.type === 'follow' ? 'Comenz贸 a seguirte' : 'Nueva notificaci贸n'}
                            </p>
                        </div>
                        <div className="w-2 h-2 bg-cyan-400 rounded-full"></div>
                    </div>
                </div>
            );
        };
        
        // --- CHAT: COMPONENTE DE MENSAJE CON MEN DE CONTEXTO ---
        const MessageBubble = ({ message, isMe, onDelete, onReply, videos }) => {
            const [showMenu, setShowMenu] = useState(false);
            const video = message.type === 'video' ? videos.find(v => v.id === message.videoId) : null;
            
            const handlePress = () => {
                setShowMenu(true);
                setTimeout(() => setShowMenu(false), 3000); // Cerrar despu茅s de 3s
            };

            const isGif = message.type === 'image' && (message.fileUrl.toLowerCase().endsWith('.gif') || message.fileUrl.toLowerCase().includes('.gif'));
            const fileIcon = message.fileType === 'audio' ? <Mic size={16} className={isMe ? 'text-black' : 'text-white'}/> : <FileText size={16} className={isMe ? 'text-black' : 'text-white'}/>;

            return (
                <div className={`flex ${isMe ? 'justify-end' : 'justify-start'} relative`}>
                    <div 
                        onDoubleClick={handlePress} 
                        onClick={handlePress} 
                        className={`max-w-[70%] p-3 rounded-2xl text-sm transition-all relative ${isMe ? 'bg-white text-black' : 'bg-gray-800 text-white'} ${showMenu ? 'scale-[1.02] shadow-lg' : ''}`}
                    >
                        {/* Men煤 de Contexto */}
                        {showMenu && (
                            <div className={`absolute -top-8 ${isMe ? 'right-0' : 'left-0'} flex bg-gray-950 rounded-lg shadow-xl overflow-hidden border border-gray-700 z-10 text-xs`}>
                                <button onClick={() => {onReply(message); setShowMenu(false);}} className="p-2 text-white hover:bg-gray-700 flex items-center gap-1">Responder</button>
                                {isMe && <button onClick={() => {onDelete(message.id); setShowMenu(false);}} className="p-2 text-red-400 hover:bg-red-900/50 flex items-center gap-1">Borrar</button>}
                            </div>
                        )}

                        {/* Mensaje de respuesta (citado) */}
                        {message.replyTo && (
                            <div className="p-2 mb-2 bg-white/10 border-l-4 border-cyan-400 rounded-md text-xs text-gray-300">
                                <p className="font-bold text-cyan-400">Respondiendo a {message.replyTo.senderId === auth.currentUser.uid ? 't铆' : 'otro'}</p>
                                <p className="truncate italic">{message.replyTo.text || message.replyTo.type}</p>
                            </div>
                        )}

                        {/* Contenido del mensaje */}
                        {message.type === 'text' && message.text}
                        
                        {message.type === 'image' && (
                            <img 
                                src={message.fileUrl} 
                                alt={isGif ? "GIF animado" : "Imagen"} 
                                className={`max-w-full rounded-lg ${isGif ? 'max-h-60' : 'max-h-48'}`}
                            />
                        )}
                        
                        {message.type === 'audio' && (
                            <div className="flex items-center gap-2">
                                {fileIcon}
                                <audio controls src={message.fileUrl} className="w-full h-8" />
                            </div>
                        )}
                        
                        {message.type === 'file' && (
                            <a href={message.fileUrl} target="_blank" className="flex items-center gap-2 text-cyan-400 hover:underline">
                                {fileIcon} Archivo Adjunto
                            </a>
                        )}

                        {message.type === 'video' && video && (
                            <div className="relative aspect-[9/16] w-32 h-48 bg-black rounded-lg overflow-hidden">
                                <video src={video.url + '#t=0.1'} className="w-full h-full object-cover" muted preload="metadata" />
                                <div className="absolute inset-0 flex flex-col justify-end p-2 bg-gradient-to-t from-black/70 to-transparent">
                                    <Play size={20} className="text-white fill-white mb-1"/>
                                    <p className="text-xs font-bold text-white truncate">{video.description || 'Video Compartido'}</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PANTALLAS ---
        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError("");
                setLoading(true);
                const email = `${username.toLowerCase().replace(/\s/g, '')}@liveclips.internal`;
                try {
                if (isRegistering) {
                    const uc = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uc.user.uid), {
                        displayName: username, username, photoURL: `https://api.dicebear.com/7.x/avataaars/svg?seed=${uc.user.uid}`,
                        bannerURL: 'https://placehold.co/600x150/1f2937/d1d5db?text=Toca+para+cambiar+el+Banner', // Banner por defecto
                        bio: "Hola, soy nuevo aqu铆.", createdAt: new Date().toISOString(), stats: { followers: 0, following: 0, likes: 0 }
                    });
                    await updateProfile(uc.user, { displayName: username });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            return (
                <div className="flex flex-col items-center justify-center h-screen bg-gray-950 text-white p-6 relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-br from-gray-900 via-black to-gray-900 z-0"></div>
                <div className="z-10 w-full max-w-sm bg-gray-900/80 backdrop-blur-xl border border-gray-700 p-8 rounded-3xl shadow-2xl">
                    <div className="flex flex-col items-center mb-8">
                    <h1 className="text-3xl font-bold text-white mb-2">LiveClips</h1>
                    <p className="text-gray-400 text-sm">Tu mundo en video</p>
                    </div>
                    <form onSubmit={handleAuth} className="space-y-4">
                    <input type="text" placeholder="Usuario" className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-600 outline-none focus:border-white transition" value={username} onChange={(e) => setUsername(e.target.value)} />
                    <input type="password" placeholder="Contrase帽a" className="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-600 outline-none focus:border-white transition" value={password} onChange={(e) => setPassword(e.target.value)} />
                    {error && <p className="text-red-400 text-xs">{error}</p>}
                    <button type="submit" disabled={loading} className="w-full bg-white hover:bg-gray-200 text-black font-bold py-4 rounded-xl transition flex justify-center">{loading ? <Loader2 className="animate-spin" /> : (isRegistering ? "Registrarse" : "Entrar")}</button>
                    </form>
                    <p className="mt-6 text-center text-sm text-gray-400 cursor-pointer hover:text-white transition" onClick={() => setIsRegistering(!isRegistering)}>{isRegistering ? "驴Ya tienes cuenta?" : "Crear cuenta nueva"}</p>
                </div>
                </div>
            );
        };

        const VideoPlayer = ({ video, isActive, toggleLike, onShare, onVisitProfile }) => {
            const videoRef = useRef(null);
            const [playing, setPlaying] = useState(false);
            const [progress, setProgress] = useState(0);
            const [buffering, setBuffering] = useState(false);
            const [hasLiked, setHasLiked] = useState(false);

            // Listener para verificar si ya dimos like
            useEffect(() => {
                if(!auth.currentUser || !video.id) return;
                const likeRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', video.id, 'likes', auth.currentUser.uid);
                const unsubscribe = auth.currentUser ? onSnapshot(likeRef, (s) => {
                    setHasLiked(s.exists());
                }) : () => {};
                return () => unsubscribe();
            }, [video.id, auth.currentUser]);

            useEffect(() => {
                const videoEl = videoRef.current;
                if (!videoEl) return;

                if (isActive) {
                const playPromise = videoEl.play();
                if (playPromise !== undefined) {
                    playPromise
                    .then(() => {
                        setPlaying(true);
                        videoEl.muted = false;
                    })
                    .catch(() => {
                        videoEl.muted = true;
                        videoEl.play().then(() => setPlaying(true)).catch(() => setPlaying(false));
                    });
                }
                } else {
                videoEl.pause();
                videoEl.currentTime = 0;
                setPlaying(false);
                }
            }, [isActive]);

            useEffect(() => {
                const el = videoRef.current;
                if(!el) return;
                const wait = () => setBuffering(true);
                const play = () => setBuffering(false);
                el.addEventListener('waiting', wait);
                el.addEventListener('playing', play);
                return () => { el.removeEventListener('waiting', wait); el.removeEventListener('playing', play); };
            }, []);

            const togglePlay = () => {
                const el = videoRef.current;
                if(!el) return;
                if(el.paused) { el.play(); setPlaying(true); } else { el.pause(); setPlaying(false); }
            };

            const handleTime = () => {
                if(videoRef.current) setProgress((videoRef.current.currentTime / videoRef.current.duration) * 100);
            };

            const handleLikeClick = () => {
                if(!hasLiked) {
                    toggleLike(video, auth.currentUser.uid);
                }
            };

            const actionBtnClass = "p-2 bg-gray-800/80 rounded-xl border border-gray-600 backdrop-blur-md transition-all active:scale-90 hover:bg-gray-700 hover:border-gray-400 shadow-lg";

            return (
                <div className="relative w-full h-full snap-start bg-gray-900 overflow-hidden" style={{ height: '100dvh' }}>
                <video
                    ref={videoRef}
                    src={video.url}
                    className="w-full h-full object-cover opacity-90"
                    loop
                    playsInline
                    onClick={togglePlay}
                    onTimeUpdate={handleTime}
                />
                
                {buffering && <div className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none"><Loader2 size={50} className="text-white/50 animate-spin"/></div>}
                
                {!playing && !buffering && (
                    <div className="absolute inset-0 flex items-center justify-center z-20 pointer-events-none">
                    <div className="bg-white/10 backdrop-blur-md p-6 rounded-full border border-white/20 shadow-xl">
                        <Play size={40} className="text-white fill-white opacity-80" />
                    </div>
                    </div>
                )}

                <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-800/50 z-30">
                    <div className="h-full bg-white transition-all duration-100 ease-linear shadow-[0_0_10px_rgba(255,255,255,0.5)]" style={{ width: `${progress}%` }} />
                </div>

                <div className="absolute right-2 bottom-28 flex flex-col items-center gap-5 z-30">
                    <div onClick={() => onVisitProfile(video.authorId)} className="relative cursor-pointer transition-transform active:scale-90 mb-2">
                    <div className="w-12 h-12 rounded-full border-2 border-white p-0.5 overflow-hidden bg-gray-800 shadow-lg">
                        <img src={video.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${video.authorId}`} className="w-full h-full object-cover" />
                    </div>
                    <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-pink-500 rounded-full w-5 h-5 flex items-center justify-center shadow-md ring-2 ring-gray-900">
                        <span className="text-white text-[10px] font-bold">+</span>
                    </div>
                    </div>

                    <button onClick={handleLikeClick} disabled={hasLiked} className="flex flex-col items-center gap-1 group disabled:opacity-70">
                    <div className={actionBtnClass}>
                        <img src={ICONS.corazon} className={`w-7 h-7 transition-all duration-300 drop-shadow-lg ${hasLiked ? 'filter-red' : 'invert opacity-90'}`} />
                    </div>
                    <span className="text-white text-xs font-medium drop-shadow-md">{video.likes}</span>
                    </button>

                    <button onClick={() => onShare(video.id)} className="flex flex-col items-center gap-1 group">
                    <div className={actionBtnClass}>
                        <img src={ICONS.compartir} className="w-7 h-7 invert opacity-90 drop-shadow-lg" />
                    </div>
                    <span className="text-white text-xs font-medium drop-shadow-md">Share</span>
                    </button>

                    <div className={`mt-2 w-12 h-12 rounded-full bg-gray-800 border-[3px] border-gray-700 flex items-center justify-center overflow-hidden ${playing ? 'animate-spin-slow' : ''} shadow-lg`}>
                        <div className="w-full h-full bg-gradient-to-br from-gray-700 to-black flex items-center justify-center">
                            <Music2 size={14} className="text-white drop-shadow-md" />
                        </div>
                    </div>
                </div>

                <div className="absolute bottom-24 left-4 right-20 z-20 text-white pointer-events-none">
                    <h3 className="font-bold text-lg drop-shadow-lg mb-2 text-gray-100 cursor-pointer pointer-events-auto w-fit" onClick={() => onVisitProfile(video.authorId)}>@{video.authorName}</h3>
                    <p className="text-sm drop-shadow-md line-clamp-2 mb-4 text-gray-200 font-light leading-relaxed">{video.description}</p>
                    <div className="flex items-center gap-2 text-xs font-medium bg-white/5 border border-white/10 w-fit px-4 py-2 rounded-full backdrop-blur-md shadow-sm">
                    <Music2 size={12} />
                    <span className="animate-marquee whitespace-nowrap max-w-[150px] overflow-hidden text-ellipsis">Sonido original - {video.authorName}</span>
                    </div>
                </div>
                </div>
            );
        };

        const ProfileView = ({ targetUserId, currentUser, videos, onBack, onVideoClick, onLogout, onChat }) => {
            const [profile, setProfile] = useState(null);
            const [isFollowing, setIsFollowing] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            
            const isMyProfile = targetUserId === currentUser.uid;
            const userVideos = videos.filter(v => v.authorId === targetUserId);

            useEffect(() => {
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUserId), (s) => {
                if (s.exists()) setProfile(s.data());
                });
                if (!isMyProfile) {
                    const checkFollow = onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'following', targetUserId), (s) => {
                        setIsFollowing(s.exists());
                    });
                    return () => { unsub(); checkFollow(); };
                }
                return () => unsub();
            }, [targetUserId, currentUser]);

            const handleFollow = async () => {
                const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'following', targetUserId);
                const targetPublicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUserId);
                const myPublicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);

                if (isFollowing) {
                    await deleteDoc(myRef);
                    await updateDoc(targetPublicRef, { "stats.followers": increment(-1) });
                    await updateDoc(myPublicRef, { "stats.following": increment(-1) });
                } else {
                    await setDoc(myRef, { since: new Date().toISOString() });
                    await updateDoc(targetPublicRef, { "stats.followers": increment(1) });
                    await updateDoc(myPublicRef, { "stats.following": increment(1) });
                    // Notificaci贸n al seguir
                    await addDoc(collection(db, 'artifacts', appId, 'users', targetUserId, 'notifications'), {
                        type: 'follow', fromUser: currentUser.uid, fromName: currentUser.displayName || "Usuario",
                        avatar: currentUser.photoURL || "", createdAt: new Date().toISOString()
                    });
                }
            };

            return (
                <div className="w-full h-full bg-gray-900 overflow-y-auto pb-24 animate-in slide-in-from-right">
                
                {/* Banner */}
                <div className="relative w-full h-40 bg-gray-950 border-b border-gray-800 shadow-md" style={{backgroundImage: `url(${profile?.bannerURL})`, backgroundSize: 'cover', backgroundPosition: 'center'}}>
                    <div className="absolute inset-0 bg-black/30"></div>
                    {!isMyProfile && (
                        <div className="absolute top-0 left-0 w-full p-4 pt-8 flex items-center gap-4 z-10">
                            <button onClick={onBack}><ArrowLeft className="text-white"/></button>
                            <span className="font-bold text-white">{profile?.displayName}</span>
                        </div>
                    )}
                </div>

                <div className="flex flex-col items-center justify-center mb-6 px-4 -mt-16 relative z-10">
                    <div className="w-24 h-24 rounded-full border-4 border-gray-900 p-1 mb-3 bg-gray-900 shadow-xl">
                        <img src={profile?.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${targetUserId}`} className="w-full h-full rounded-full bg-gray-800 object-cover" />
                    </div>
                    <h2 className="text-lg font-bold text-white">@{profile?.username || "Usuario"}</h2>
                    <p className="text-sm text-gray-400 text-center mt-1">{profile?.bio || "Sin biograf铆a"}</p>
                    
                    <div className="flex items-center gap-8 mt-6 text-center">
                        <div><div className="font-bold text-white text-lg">{profile?.stats?.following || 0}</div><div className="text-xs text-gray-500 uppercase font-bold">Siguiendo</div></div>
                        <div><div className="font-bold text-white text-lg">{profile?.stats?.followers || 0}</div><div className="text-xs text-gray-500 uppercase font-bold">Seguidores</div></div>
                        <div><div className="font-bold text-white text-lg">{profile?.stats?.likes || 0}</div><div className="text-xs text-gray-500 uppercase font-bold">Likes</div></div>
                    </div>
                    
                    <div className="flex gap-2 mt-6 w-full max-w-xs px-4">
                        {isMyProfile ? (
                            <>
                                <button onClick={() => setIsEditing(true)} className="flex-1 py-2 bg-gray-800 text-white text-sm font-bold rounded-lg border border-gray-600">Editar Perfil</button>
                                <button onClick={onLogout} className="w-10 flex items-center justify-center bg-gray-800 text-white rounded-lg border border-gray-600"><LogOut size={16}/></button>
                            </>
                        ) : (
                            <>
                                <button 
                                    onClick={handleFollow}
                                    className={`flex-1 py-2 text-white text-sm font-bold rounded-lg border transition-all flex items-center justify-center gap-2
                                    ${isFollowing ? 'bg-gray-800 border-gray-600' : 'bg-white text-black hover:bg-gray-200'}`}
                                >
                                    {isFollowing ? <><UserCheck size={16}/> Siguiendo</> : <><UserPlus size={16}/> Seguir</>}
                                </button>
                                <button onClick={() => onChat(targetUserId, profile)} className="w-12 flex items-center justify-center bg-gray-800 text-white rounded-lg border border-gray-600">
                                    <MessageCircle size={18}/>
                                </button>
                            </>
                        )}
                    </div>
                </div>

                <div className="border-t border-gray-800 w-full bg-gray-900 min-h-[300px]">
                    <div className="grid grid-cols-3 gap-0.5">
                        {userVideos.map((video, idx) => (
                            <div key={video.id} onClick={() => onVideoClick(video.id)} className="relative aspect-[3/4] bg-gray-800 cursor-pointer overflow-hidden">
                            {/* Miniatura truco: video pausado sin controles */}
                            <video src={video.url + '#t=0.1'} className="w-full h-full object-cover opacity-90 hover:opacity-100 transition" preload="metadata" />
                            <div className="absolute bottom-1 left-1 flex items-center gap-1 text-[10px] text-white font-bold drop-shadow-md">
                                <Play size={10} fill="white"/> {video.likes || 0}
                            </div>
                            </div>
                        ))}
                    </div>
                </div>
                
                {isMyProfile && <EditProfileModal isOpen={isEditing} onClose={() => setIsEditing(false)} user={currentUser} profile={profile} onUpdate={()=>{}} />}
                </div>
            );
        };

        const EditProfileModal = ({ isOpen, onClose, user, profile }) => {
            const [displayName, setDisplayName] = useState(profile?.displayName || "");
            const [bio, setBio] = useState(profile?.bio || "");
            const [loading, setLoading] = useState(false);
            const photoInputRef = useRef(null);
            const bannerInputRef = useRef(null);

            useEffect(() => { 
                if(profile) { setDisplayName(profile.displayName||""); setBio(profile.bio||""); } 
            }, [profile]);
            
            const handleImageUpload = async (event, type) => {
                const file = event.target.files[0];
                if (!file) return;

                setLoading(true);
                try {
                    const path = `${type}s/${user.uid}_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g,'')}`;
                    const url = await uploadToGitHub(file, path, (s) => alert(s)); 
                    
                    const updateData = type === 'photo' ? { photoURL: url } : { bannerURL: url };
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), updateData);
                } catch(e) {
                    alert("Error al subir imagen: " + e.message);
                }
                setLoading(false);
            };

            const handleSaveText = async () => {
                setLoading(true);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), { displayName, bio });
                setLoading(false); onClose();
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6">
                <div className="bg-gray-900 w-full max-w-xs rounded-xl p-6 border border-gray-700">
                    <h3 className="text-white font-bold mb-4">Editar Perfil</h3>
                    
                    {loading && <div className="text-cyan-400 mb-4 flex items-center gap-2"><Loader2 className="animate-spin" size={16}/> Cargando im谩genes...</div>}

                    <div className="flex flex-col items-center mb-4">
                        <label className="relative cursor-pointer mb-2">
                            <div className="w-16 h-16 rounded-full border-2 border-white overflow-hidden bg-gray-800">
                                <img src={profile?.photoURL} className="w-full h-full object-cover"/>
                            </div>
                            <div className="absolute bottom-0 right-0 bg-cyan-600 rounded-full p-1.5 border border-gray-900"><Camera size={14} className="text-white"/></div>
                            <input type="file" accept="image/*" className="hidden" ref={photoInputRef} onChange={(e) => handleImageUpload(e, 'photo')} />
                        </label>
                        <button onClick={() => photoInputRef.current.click()} className="text-xs text-gray-400 hover:text-white">Cambiar Foto</button>
                    </div>

                    <div className="w-full mb-4">
                        <label className="relative cursor-pointer w-full h-16 block bg-gray-800 border border-gray-600 rounded-lg overflow-hidden">
                            <img src={profile?.bannerURL} className="w-full h-full object-cover"/>
                            <div className="absolute inset-0 flex items-center justify-center bg-black/40 hover:bg-black/60 transition"><Camera size={18} className="text-white"/></div>
                            <input type="file" accept="image/*" className="hidden" ref={bannerInputRef} onChange={(e) => handleImageUpload(e, 'banner')} />
                        </label>
                        <button onClick={() => bannerInputRef.current.click()} className="text-xs text-gray-400 hover:text-white mt-1 block">Cambiar Banner (GIF permitido)</button>
                    </div>

                    <input value={displayName} onChange={e => setDisplayName(e.target.value)} className="w-full bg-gray-800 text-white p-3 rounded-lg mb-3 outline-none" placeholder="Nombre" />
                    <textarea value={bio} onChange={e => setBio(e.target.value)} className="w-full bg-gray-800 text-white p-3 rounded-lg mb-4 outline-none" placeholder="Bio" rows={3} />
                    <button onClick={handleSaveText} disabled={loading} className="w-full bg-white text-black font-bold py-3 rounded-lg">{loading ? "Guardando..." : "Guardar Texto"}</button>
                    <button onClick={onClose} className="w-full text-gray-400 text-sm mt-3">Cerrar</button>
                </div>
                </div>
            );
        };

        const UploadModal = ({ isOpen, onClose, user }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [desc, setDesc] = useState("");
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("");

            const handleFile = (e) => { const f = e.target.files[0]; if(f) { setFile(f); setPreview(URL.createObjectURL(f)); }};
            const handleUpload = async () => {
                if(!file) return;
                setLoading(true);
                try {
                    const path = `videos/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g,'')}`;
                    const url = await uploadToGitHub(file, path, setStatus);
                    const userData = (await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid))).data();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), {
                        url, authorId: user.uid, authorName: userData.displayName, authorAvatar: userData.photoURL,
                        description: desc, likes: 0, commentsCount: 0, createdAt: new Date().toISOString()
                    });
                    onClose(); setFile(null); setPreview(null); setDesc("");
                } catch(e) { setStatus("Error: " + e.message); }
                setLoading(false);
            };

            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-gray-900/95 backdrop-blur-xl flex flex-col animate-in fade-in">
                    <div className="p-4 flex justify-between items-center border-b border-gray-700">
                        <button onClick={onClose}><X className="text-gray-400 hover:text-white"/></button>
                        <h3 className="text-white font-bold flex items-center gap-2"><img src={ICONS.crear} className="w-6 h-6 invert"/> Nuevo Video</h3>
                        <div className="w-6"></div>
                    </div>
                    <div className="flex-1 p-6 flex flex-col items-center justify-center">
                        {!preview ? (
                            <label className="w-full h-64 border-2 border-dashed border-gray-600 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 bg-gray-800/30">
                                <div className="p-4 rounded-full bg-gray-700 mb-3"><img src={ICONS.crear} className="w-8 h-8 invert opacity-70"/></div>
                                <span className="text-gray-400 font-medium">Seleccionar video</span>
                                <input type="file" accept="video/*" className="hidden" onChange={handleFile}/>
                            </label>
                        ) : (
                            <div className="relative w-full h-64 bg-black rounded-2xl overflow-hidden border border-gray-700">
                                <video src={preview} className="w-full h-full object-contain"/>
                                <button onClick={()=>{setPreview(null);setFile(null)}} className="absolute top-2 right-2 bg-black/50 p-1.5 rounded-full text-white hover:bg-black/80"><X size={16}/></button>
                            </div>
                        )}
                        <textarea value={desc} onChange={e=>setDesc(e.target.value)} placeholder="A帽ade una descripci贸n..." className="w-full bg-gray-900 text-white p-4 rounded-xl mt-6 h-24 outline-none resize-none border border-gray-700 focus:border-gray-500"/>
                        {status && <p className="text-cyan-400 text-sm mt-2 animate-pulse">{status}</p>}
                        <button disabled={loading||!file} onClick={handleUpload} className="w-full bg-white text-black font-bold py-3.5 rounded-xl mt-auto mb-4 disabled:opacity-50 hover:bg-gray-200 transition shadow-lg">{loading?"Publicando...":"Publicar Video"}</button>
                    </div>
                </div>
            );
        };

        const TrendsView = ({ videos, onVideoClick, onVisitProfile }) => {
            const [search, setSearch] = useState("");
            const [tab, setTab] = useState('videos');
            const [users, setUsers] = useState([]);
            
            // B煤squeda de usuarios
            useEffect(() => {
                if (tab === 'users' && search.length >= 2) {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('displayName', '>=', search), 
                        where('displayName', '<=', search + '\uf8ff'),
                        limit(10)
                    );
                    const unsub = onSnapshot(q, (snap) => {
                        setUsers(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(u => u.id !== auth.currentUser.uid));
                    });
                    return () => unsub();
                } else if (tab === 'users') {
                    setUsers([]);
                }
            }, [tab, search]);
            
            const filteredVideos = videos.filter(v => 
                (v.description || "").toLowerCase().includes(search.toLowerCase()) ||
                (v.authorName || v.author || "").toLowerCase().includes(search.toLowerCase())
            );
            
            return (
                <div className="w-full h-full bg-gray-900 pt-16 px-4 overflow-y-auto pb-24">
                <div className="relative mb-6">
                    <input type="text" placeholder="Buscar..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full bg-gray-800 text-white p-3 pl-10 rounded-xl border border-gray-700 outline-none" />
                    <Search className="absolute left-3 top-3.5 text-gray-500" size={18} />
                </div>
                
                <div className="flex gap-4 mb-6 border-b border-gray-800 pb-2">
                    <button onClick={() => setTab('videos')} className={`text-sm font-bold pb-2 ${tab==='videos'?'text-white border-b-2 border-white':'text-gray-500'}`}>Videos</button>
                    <button onClick={() => setTab('users')} className={`text-sm font-bold pb-2 ${tab==='users'?'text-white border-b-2 border-white':'text-gray-500'}`}>Usuarios</button>
                </div>
                
                {tab === 'videos' && (
                    <>
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Hash className="text-cyan-400" size={18} /> Resultados de Videos</h3>
                        <div className="grid grid-cols-2 gap-2">
                            {filteredVideos.map(video => (
                            <div key={video.id} onClick={() => onVideoClick(video)} className="relative aspect-[9/16] bg-gray-800 rounded-xl overflow-hidden cursor-pointer group shadow-lg border border-gray-800">
                                <video src={video.url + '#t=0.1'} className="w-full h-full object-cover opacity-80" muted preload="metadata" />
                                <div className="absolute bottom-0 inset-x-0 p-2 bg-gradient-to-t from-black/80 to-transparent">
                                    <p className="text-xs font-bold text-white truncate">@{video.authorName}</p>
                                </div>
                            </div>
                            ))}
                        </div>
                    </>
                )}
                
                {tab === 'users' && (
                    <>
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><UserIcon className="text-cyan-400" size={18} /> Usuarios Encontrados</h3>
                        <div className="space-y-2">
                            {users.length === 0 && search.length >= 2 ? <p className="text-gray-500 text-center">No se encontraron usuarios.</p> :
                            users.map(u => (
                                <div key={u.id} onClick={() => onVisitProfile(u.id)} className="flex items-center gap-3 p-3 bg-gray-800/40 rounded-xl border border-gray-800 cursor-pointer hover:bg-gray-800">
                                    <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden flex-shrink-0">
                                        <img src={u.photoURL} className="w-full h-full object-cover"/>
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-bold text-white">@{u.username}</p>
                                        <p className="text-xs text-gray-400 truncate">{u.displayName}</p>
                                    </div>
                                    <UserPlus size={18} className="text-cyan-400"/>
                                </div>
                            ))}
                        </div>
                    </>
                )}
                </div>
            );
        };

        const InboxView = ({ user, onOpenChat, notifications, chats }) => {
            const [tab, setTab] = useState('chats'); 

            const myChats = chats.filter(c => c.status === 'accepted');
            const requests = chats.filter(c => c.status === 'pending' && c.participants.includes(user.uid));

            const handleAccept = async (chatId, targetUid) => {
                await updateDoc(doc(db, 'artifacts', appId, 'chats', chatId), { status: 'accepted', targetId: null });
                // Enviar notificaci贸n al que solicit贸
                const userData = (await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid))).data();
                 await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'notifications'), {
                    type: 'message_accept', fromUser: user.uid, fromName: userData.displayName, avatar: userData.photoURL, createdAt: new Date().toISOString()
                });
            };

            return (
                <div className="w-full h-full bg-gray-900 pt-16 px-4 overflow-y-auto pb-24">
                <div className="flex gap-4 mb-6 border-b border-gray-800 pb-2">
                    <button onClick={() => setTab('chats')} className={`text-sm font-bold pb-2 ${tab==='chats'?'text-white border-b-2 border-white':'text-gray-500'}`}>Mensajes</button>
                    <button onClick={() => setTab('requests')} className={`text-sm font-bold pb-2 ${tab==='requests'?'text-white border-b-2 border-white':'text-gray-500'}`}>Solicitudes {requests.length > 0 && <span className="text-red-500">({requests.length})</span>}</button>
                </div>

                <div className="space-y-2">
                    {tab === 'chats' ? (
                        myChats.length === 0 ? <div className="text-center text-gray-500 mt-10">No tienes mensajes</div> :
                        myChats.map(chat => {
                            const otherUid = chat.participants.find(uid => uid !== user.uid);
                            const otherName = chat.participantsData?.[otherUid]?.displayName || "Usuario";
                            const otherImg = chat.participantsData?.[otherUid]?.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${otherUid}`; 
                            
                            // Verificar racha
                            const isStreakActive = chat.streak && chat.streak.count > 0 && 
                                (new Date().getTime() - new Date(chat.streak.lastMessageTime).getTime() < 86400000);

                            return (
                                <div key={chat.id} onClick={() => onOpenChat(chat.id)} className="flex items-center gap-3 p-3 bg-gray-800/40 rounded-xl border border-gray-800 cursor-pointer hover:bg-gray-800">
                                    <div className="w-12 h-12 rounded-full bg-gray-700 overflow-hidden border border-gray-600 flex-shrink-0 relative">
                                        <img src={otherImg} className="w-full h-full object-cover"/>
                                        {isStreakActive && (
                                            <div className="absolute -bottom-1 -right-1 bg-yellow-500 rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold shadow-lg">
                                                
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-bold text-white flex items-center gap-2">
                                            {otherName} 
                                            {isStreakActive && <span className="text-yellow-400 text-xs">x{chat.streak.count}</span>}
                                        </p>
                                        <p className="text-xs text-gray-400">Toca para chatear</p>
                                    </div>
                                </div>
                            )
                        })
                    ) : (
                        requests.length === 0 ? <div className="text-center text-gray-500 mt-10">No tienes solicitudes</div> :
                        requests.map(req => {
                            const senderUid = req.participants.find(uid => uid !== user.uid);
                            const senderName = req.participantsData?.[senderUid]?.displayName || "Usuario";
                            return (
                                <div key={req.id} className="flex items-center gap-3 p-3 bg-gray-800/40 rounded-xl border border-gray-800">
                                    <div className="flex-1">
                                        <p className="font-bold text-white">Solicitud de {senderName}</p>
                                        <p className="text-xs text-gray-400">Quiere chatear contigo</p>
                                    </div>
                                    <button onClick={() => handleAccept(req.id, senderUid)} className="px-4 py-2 bg-white text-black rounded-lg text-xs font-bold">Aceptar</button>
                                </div>
                            )
                        })
                    )}
                </div>
                </div>
            );
        };

        const ChatScreen = ({ chatId, user, onClose, videos }) => {
            const [messages, setMessages] = useState([]);
            const [txt, setTxt] = useState("");
            const [file, setFile] = useState(null);
            const [replyTo, setReplyTo] = useState(null);
            const [isTyping, setIsTyping] = useState(false);
            const endRef = useRef(null);
            
            const [isRecording, setIsRecording] = useState(false);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const typingTimerRef = useRef(null);

            // Listener de mensajes
            useEffect(() => {
                if(!chatId) return;
                // Orden descendente para que el CSS column-reverse funcione
                const q = query(collection(db, 'artifacts', appId, 'chats', chatId, 'messages'), orderBy('createdAt', 'desc')); 
                const unsub = onSnapshot(q, s => {
                    setMessages(s.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, [chatId]);
            
            // Scroll al final al cargar mensajes (siempre despu茅s de que se cargan)
            useEffect(() => {
                if (endRef.current) {
                    endRef.current.scrollIntoView({ behavior: 'auto' });
                }
            }, [messages.length, activeChatId]);
            
            // Listener del Typing Indicator (Obtiene el estado de "escribiendo" del chat doc)
            useEffect(() => {
                if(!chatId) return;
                const chatRef = doc(db, 'artifacts', appId, 'chats', chatId);
                return onSnapshot(chatRef, (snap) => {
                    const typingUser = snap.data().typing;
                    if (typingUser && typingUser !== user.uid) {
                        setIsTyping(true);
                    } else {
                        setIsTyping(false);
                    }
                });
            }, [chatId]);
            
            // Funci贸n para actualizar el estado de "escribiendo" en Firebase
            const setTypingStatus = (status) => {
                const chatRef = doc(db, 'artifacts', appId, 'chats', chatId);
                updateDoc(chatRef, { typing: status ? user.uid : null }).catch(console.error);
            };

            // Manejar la escritura del usuario
            const handleTextChange = (e) => {
                setTxt(e.target.value);
                
                if (e.target.value.length > 0) {
                    if (!typingTimerRef.current) {
                        setTypingStatus(true);
                    }
                    clearTimeout(typingTimerRef.current);
                    typingTimerRef.current = setTimeout(() => {
                        setTypingStatus(false);
                        typingTimerRef.current = null;
                    }, 3000);
                } else {
                    clearTimeout(typingTimerRef.current);
                    setTypingStatus(false);
                    typingTimerRef.current = null;
                }
            };
            
            // Cleanup para el typing indicator al salir
            useEffect(() => {
                return () => {
                    clearTimeout(typingTimerRef.current);
                    if (auth.currentUser) setTypingStatus(false);
                };
            }, [chatId]);
            
            const updateStreak = async () => {
                const chatRef = doc(db, 'artifacts', appId, 'chats', chatId);
                const snap = await getDoc(chatRef);
                if (!snap.exists()) return;

                const chatData = snap.data();
                const now = new Date().getTime();
                
                const lastTime = chatData.streak ? new Date(chatData.streak.lastMessageTime).getTime() : 0;
                const lastSender = chatData.streak ? chatData.streak.lastSenderId : null;
                const currentCount = chatData.streak ? chatData.streak.count : 0;
                
                const isWithin24Hours = (now - lastTime) < 86400000; // 24 horas en ms
                const streakLost = (now - lastTime) >= 86400000;

                let newCount = currentCount;

                if (currentCount === 0) {
                    newCount = 1; 
                } else if (isWithin24Hours && lastSender !== user.uid) {
                    newCount = currentCount + 1; 
                } else if (streakLost) {
                    newCount = 1; 
                } else if (lastSender === user.uid) {
                    newCount = currentCount; 
                }
                
                await updateDoc(chatRef, {
                    streak: {
                        count: newCount,
                        lastMessageTime: new Date().toISOString(),
                        lastSenderId: user.uid
                    }
                });
            };

            const sendMessage = async (type, content, fileDetails = null) => {
                const message = {
                    type,
                    senderId: user.uid,
                    createdAt: new Date().toISOString(),
                    ...(type === 'text' ? { text: content } : { fileUrl: content, fileType: fileDetails?.fileType || 'file' }),
                    ...(type === 'video' ? { videoId: content } : {}),
                    ...(replyTo ? { replyTo: { text: replyTo.text, type: replyTo.type, senderId: replyTo.senderId } } : {}),
                };

                await addDoc(collection(db, 'artifacts', appId, 'chats', chatId, 'messages'), message);
                await updateStreak(); 
                setTypingStatus(false); 
                
                const chatDoc = await getDoc(doc(db, 'artifacts', appId, 'chats', chatId));
                const participants = chatDoc.data().participants;
                const receiverId = participants.find(id => id !== user.uid);
                
                if (receiverId) {
                    const userData = (await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid))).data();
                    await addDoc(collection(db, 'artifacts', appId, 'users', receiverId, 'notifications'), {
                        type: 'message', 
                        fromUser: user.uid, 
                        fromName: userData.displayName || "Usuario", 
                        avatar: userData.photoURL || "", 
                        createdAt: new Date().toISOString()
                    });
                }
            };

            const sendText = () => {
                if(!txt.trim()) return;
                sendMessage('text', txt.trim());
                setTxt("");
                setReplyTo(null);
            };

            const handleFileSelect = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    setTxt(selectedFile.name); 
                }
            };

            const sendFile = async (selectedFile = file) => {
                if (!selectedFile) return;

                const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
                let fileType = 'file'; 
                if (['png', 'jpg', 'jpeg', 'gif'].includes(fileExtension)) fileType = 'image';
                else if (['mp3', 'wav', 'ogg', 'webm'].includes(fileExtension)) fileType = 'audio';
                
                setTxt("Subiendo archivo...");
                const path = `chats/${chatId}/${Date.now()}_${selectedFile.name.replace(/[^a-zA-Z0-9.]/g,'')}`;
                
                try {
                    const url = await uploadToGitHub(selectedFile, path);
                    sendMessage(fileType, url, { fileType });
                } catch(e) {
                    alert("Error al subir archivo: " + e.message);
                } finally {
                    setFile(null);
                    setTxt("");
                    setReplyTo(null);
                }
            };
            
            // --- LGICA DE GRABACIN DE AUDIO REAL ---
            const startRecording = async () => {
                if (isRecording) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const options = { mimeType: 'audio/webm' }; // Formato de audio para Web/GitHub
                    const recorder = new MediaRecorder(stream, options);
                    mediaRecorderRef.current = recorder;
                    audioChunksRef.current = [];
                    
                    recorder.ondataavailable = (event) => {
                        audioChunksRef.current.push(event.data);
                    };
                    
                    recorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                        const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`, { type: 'audio/webm' });
                        await sendFile(audioFile); // Usar la funci贸n sendFile existente para subir a GitHub
                        stream.getTracks().forEach(track => track.stop()); // Detener el micr贸fono
                    };

                    recorder.start();
                    setIsRecording(true);
                    setTxt("Grabando...");
                    
                } catch (err) {
                    alert('Error al acceder al micr贸fono: ' + err.message);
                    setIsRecording(false);
                }
            };
            
            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    setTxt("");
                }
            };


            const deleteMsg = async (msgId) => {
                if (window.confirm("驴Seguro que quieres borrar este mensaje?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'chats', chatId, 'messages', msgId));
                }
            };
            
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (file) {
                        sendFile();
                    } else {
                        sendText();
                    }
                }
            };

            return (
                <div className="absolute inset-0 z-50 bg-gray-900 flex flex-col animate-in slide-in-from-right h-[100dvh]">
                    <div className="p-4 bg-gray-900 border-b border-gray-800 flex items-center gap-4">
                        <button onClick={onClose}><ArrowLeft className="text-white"/></button>
                        <span className="font-bold text-white">Chat</span>
                    </div>
                    
                    <div className="message-list-container">
                        <div ref={endRef} />
                        <div className="message-list-content">
                            {/* Los mensajes se mapean inversamente por el CSS column-reverse */}
                            {messages.slice().reverse().map((m) => ( 
                                <MessageBubble 
                                    key={m.id} 
                                    message={m} 
                                    isMe={m.senderId === user.uid} 
                                    onDelete={deleteMsg}
                                    onReply={setReplyTo}
                                    videos={videos}
                                />
                            ))}
                        </div>
                    </div>
                    
                    {/* Indicador de escribiendo */}
                    {isTyping && (
                        <div className="px-4 py-2">
                            <div className="flex justify-start">
                                <div className="max-w-[70%] p-3 rounded-2xl text-sm bg-gray-800 text-white flex items-center gap-2">
                                    <span className="text-gray-300 italic text-xs">Escribiendo</span>
                                    <div className="typing-indicator">
                                        <span className="typing-dot"></span>
                                        <span className="typing-dot"></span>
                                        <span className="typing-dot"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Input y barra de respuesta */}
                    <div className="p-3 bg-gray-900 border-t border-gray-800 flex flex-col gap-2">
                        {replyTo && (
                            <div className="flex items-center justify-between p-2 bg-gray-800 rounded-lg text-sm border-l-4 border-cyan-400">
                                <span className="text-gray-300 italic truncate">Respondiendo a: {replyTo.text || replyTo.type}</span>
                                <button onClick={() => setReplyTo(null)} className="text-red-400 ml-2"><X size={16}/></button>
                            </div>
                        )}

                        <div className="flex gap-2 items-center">
                            
                            {/* Bot贸n para Adjuntar */}
                            <label className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-gray-700 transition">
                                <FileText size={18}/>
                                <input type="file" className="hidden" onChange={handleFileSelect} />
                            </label>

                            {/* Campo de Texto */}
                            <input 
                                value={txt} 
                                onChange={handleTextChange} 
                                className="flex-1 bg-gray-800 text-white p-3 rounded-full outline-none" 
                                placeholder={isRecording ? "Grabando audio..." : (file ? file.name : "Mensaje...")}
                                onKeyDown={handleKeyDown}
                                disabled={file || isRecording}
                            />
                            
                            {/* Bot贸n de Enviar o Audio */}
                            {txt.trim() || file ? (
                                <button onClick={file ? sendFile : sendText} className="p-3 bg-white rounded-full text-black"><Send size={18}/></button>
                            ) : (
                                <button 
                                    onMouseDown={startRecording}
                                    onMouseUp={stopRecording}
                                    onTouchStart={startRecording}
                                    onTouchEnd={stopRecording}
                                    className={`p-3 rounded-full transition-all ${isRecording ? 'bg-red-500 scale-110 text-white' : 'bg-gray-800 text-white hover:bg-gray-700'}`}
                                >
                                    <Mic size={18}/>
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODAL PARA COMPARTIR VIDEO ---
        const ShareVideoModal = ({ isOpen, onClose, videoId, user, chats }) => {
            const [selectedChat, setSelectedChat] = useState(null);

            const handleSend = async () => {
                if (!selectedChat) return;
                
                const message = {
                    type: 'video',
                    videoId: videoId,
                    senderId: user.uid,
                    createdAt: new Date().toISOString(),
                };
                
                await addDoc(collection(db, 'artifacts', appId, 'chats', selectedChat, 'messages'), message);

                // L贸gica de racha
                await updateDoc(doc(db, 'artifacts', appId, 'chats', selectedChat), {
                    streak: {
                        count: increment(1),
                        lastMessageTime: new Date().toISOString(),
                        lastSenderId: user.uid
                    }
                });
                
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 bg-black/80 flex items-end">
                    <div className="bg-gray-900 w-full rounded-t-2xl p-6 border-t border-gray-700 animate-in slide-in-from-bottom">
                        <h3 className="text-white font-bold text-lg mb-4 flex justify-between items-center">
                            Compartir en Chat
                            <button onClick={onClose}><X size={20} className="text-gray-400"/></button>
                        </h3>

                        <div className="max-h-64 overflow-y-auto space-y-3 mb-6">
                            {chats.filter(c => c.status === 'accepted').map(chat => {
                                const otherUid = chat.participants.find(uid => uid !== user.uid);
                                const otherName = chat.participantsData?.[otherUid]?.displayName || "Usuario";
                                const isSelected = selectedChat === chat.id;

                                return (
                                    <div 
                                        key={chat.id} 
                                        onClick={() => setSelectedChat(chat.id)}
                                        className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition ${isSelected ? 'bg-cyan-600 border-cyan-400' : 'bg-gray-800/40 border-gray-700 hover:bg-gray-800'}`}
                                    >
                                        <div className="w-10 h-10 rounded-full bg-gray-700 overflow-hidden border border-gray-600 flex items-center justify-center text-white text-sm font-bold uppercase">{otherName[0]}</div>
                                        <span className="font-medium text-white">{otherName}</span>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <button 
                            onClick={handleSend}
                            disabled={!selectedChat}
                            className="w-full py-3.5 bg-white text-black font-bold rounded-xl disabled:opacity-50 hover:bg-gray-200 transition"
                        >
                            Enviar Video
                        </button>

                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [videos, setVideos] = useState([]);
            const [chats, setChats] = useState([]); 
            const [activeTab, setActiveTab] = useState('home');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [showUpload, setShowUpload] = useState(false);
            const [showShare, setShowShare] = useState(null); 
            const [viewingProfile, setViewingProfile] = useState(null);
            const [activeChatId, setActiveChatId] = useState(null);
            const [feedMode, setFeedMode] = useState('global');
            const [profileFeedVideos, setProfileFeedVideos] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [latestToast, setLatestToast] = useState(null);
            
            const feedRef = useRef(null);

            useEffect(() => onAuthStateChanged(auth, setUser), []);

            // Listener de datos
            useEffect(() => {
                if(!user) return;
                // Videos
                const unsubVideos = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), orderBy('createdAt', 'desc')), s => setVideos(s.docs.map(d => ({id: d.id, ...d.data()}))));
                // Chats
                const unsubChats = onSnapshot(query(collection(db, 'artifacts', appId, 'chats'), where('participants', 'array-contains', user.uid)), s => setChats(s.docs.map(d => ({id: d.id, ...d.data()}))));
                // Notificaciones
                const qNotifs = query(collection(db, 'artifacts', appId, 'users', user.uid, 'notifications'), orderBy('createdAt', 'desc'), limit(10));
                const unsubNotifs = onSnapshot(qNotifs, (snapshot) => {
                    const notifs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    if (notifs.length > 0) {
                        const newest = notifs[0];
                        const now = new Date().getTime();
                        const notifTime = new Date(newest.createdAt).getTime();
                        if (now - notifTime < 10000) {
                            setLatestToast(newest);
                        }
                    }
                    setNotifications(notifs);
                });
                
                return () => { unsubVideos(); unsubChats(); unsubNotifs(); };
            }, [user]);

            const handleScroll = () => {
                if (feedRef.current && activeTab === 'home') {
                const idx = Math.round(feedRef.current.scrollTop / feedRef.current.clientHeight);
                if (idx !== currentIndex) setCurrentIndex(idx);
                }
            };

            const toggleLike = async (video, likerId) => {
                const likeRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', video.id, 'likes', likerId);
                const likeSnap = await getDoc(likeRef);

                if (likeSnap.exists()) {
                    return; 
                } else {
                    await setDoc(likeRef, { userId: likerId, createdAt: new Date().toISOString() });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'videos', video.id), { likes: increment(1) });
                    
                    if(video.authorId !== user.uid) {
                        const uData = (await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid))).data();
                        await addDoc(collection(db, 'artifacts', appId, 'users', video.authorId, 'notifications'), {
                            type: 'like', fromUser: user.uid, fromName: uData.displayName, avatar: uData.photoURL, thumbnail: video.url, createdAt: new Date().toISOString()
                        });
                    }
                }
            };
            
            const goToProfile = (uid) => {
                setViewingProfile(uid);
                setActiveTab('profile');
            };

            const openProfileVideo = (video) => {
                let targetVid = video;
                if (!targetVid.id) targetVid = videos.find(v => v.id === video);

                const userVids = videos.filter(v => v.authorId === targetVid.authorId);
                const idx = userVids.findIndex(v => v.id === targetVid.id);
                
                setProfileFeedVideos(userVids);
                setFeedMode('profile');
                setActiveTab('home');
                setTimeout(() => {
                    setCurrentIndex(idx);
                    feedRef.current?.scrollTo({top: idx * feedRef.current.clientHeight, behavior: 'auto'});
                }, 50);
            };

            const goHome = () => {
                setFeedMode('global');
                setActiveTab('home');
                setViewingProfile(null);
            };

            const startChat = async (targetUid, targetProfile) => {
                const chatId = getChatId(user.uid, targetUid);
                const chatRef = doc(db, 'artifacts', appId, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);

                if (chatSnap.exists()) {
                    if (chatSnap.data().status === 'accepted') {
                        setActiveChatId(chatId); 
                    } else {
                        alert("Solicitud pendiente...");
                    }
                } else {
                    await setDoc(chatRef, {
                        participants: [user.uid, targetUid],
                        participantsData: {
                            [user.uid]: { displayName: user.displayName || "Usuario", photoURL: user.photoURL },
                            [targetUid]: { displayName: targetProfile.displayName || "Usuario", photoURL: targetProfile.photoURL }
                        },
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                    alert("Solicitud enviada");
                }
            };

            const currentFeedVideos = feedMode === 'global' ? videos : profileFeedVideos;

            if(!user) return <AuthScreen />;

            return (
                <div className="flex justify-center bg-black h-[100dvh] w-full font-sans text-white select-none">
                <ToastNotification notif={latestToast} onClose={() => setLatestToast(null)} />
                
                <div className="relative w-full max-w-md h-full bg-gray-900 shadow-[0_0_40px_rgba(0,0,0,0.5)] flex flex-col border-x border-gray-800 overflow-hidden">
                    
                    {activeTab === 'home' && (
                        <div className="absolute top-0 w-full p-4 pt-8 z-30 flex justify-center gap-4 bg-gradient-to-b from-gray-900/80 to-transparent pointer-events-none backdrop-blur-[1px]">
                            <span className={`font-bold text-base cursor-pointer pointer-events-auto ${feedMode==='profile'?'text-gray-400':'text-white border-b-2 border-white pb-1'}`} onClick={goHome}>Para Ti</span>
                            {feedMode === 'profile' && <span className="font-bold text-white border-b-2 pointer-events-auto pb-1">Viendo Perfil</span>}
                        </div>
                    )}

                    <div 
                        ref={feedRef} 
                        onScroll={handleScroll} 
                        className={`flex-1 overflow-y-auto snap-y snap-mandatory no-scrollbar bg-gray-900 ${activeTab !== 'home' ? 'hidden' : ''}`}
                        style={{ scrollSnapStop: 'always' }}
                    >
                        {currentFeedVideos.length > 0 ? currentFeedVideos.map((v, i) => (
                            <VideoPlayer 
                                key={v.id} 
                                video={v} 
                                isActive={i === currentIndex && activeTab === 'home'} 
                                toggleLike={toggleLike} 
                                onShare={(id) => setShowShare(id)} 
                                onVisitProfile={goToProfile}
                            />
                        )) : <div className="h-full flex items-center justify-center"><Loader2 className="animate-spin text-white/50"/></div>}
                    </div>

                    {activeTab === 'trends' && <TrendsView videos={videos} onVideoClick={openProfileVideo} onVisitProfile={goToProfile} />}

                    {activeTab === 'profile' && (
                        <ProfileView 
                            targetUserId={viewingProfile || user.uid} 
                            currentUser={user} 
                            videos={videos} 
                            onBack={() => {
                                if(feedMode === 'profile') setActiveTab('home');
                                else { setViewingProfile(null); setActiveTab('home'); }
                            }} 
                            onVideoClick={(id) => openProfileVideo({id, authorId: viewingProfile || user.uid})}
                            onLogout={() => signOut(auth)}
                            onChat={startChat}
                        />
                    )}

                    {activeTab === 'inbox' && (
                        <InboxView user={user} onOpenChat={setActiveChatId} notifications={notifications} chats={chats} />
                    )}

                    <div className="bg-gray-900/95 border-t border-gray-500 p-2 flex justify-around items-center z-40 pb-5 backdrop-blur-xl h-[80px]">
                        <button onClick={goHome} className={`flex flex-col items-center gap-1 w-14 cursor-pointer transition active:scale-90 opacity-100`}>
                            <Home size={26} strokeWidth={activeTab==='home'?3:2} className="text-white fill-white"/><span className="text-[10px] font-medium text-white">Inicio</span>
                        </button>
                        <button onClick={() => setActiveTab('trends')} className="flex flex-col items-center gap-1 w-14 cursor-pointer transition active:scale-90 opacity-50 hover:opacity-100">
                            <img src={ICONS.tendencia} className="w-7 h-7 invert"/><span className="text-[10px] font-medium text-white">Tendencias</span>
                        </button>
                        
                        <button onClick={() => setShowUpload(true)} className="relative -top-1 cursor-pointer group mx-2">
                            <div className="absolute inset-0 bg-white/20 rounded-xl blur-md group-hover:blur-lg transition duration-300 opacity-50"></div>
                            <div className="relative bg-white w-14 h-9 rounded-xl flex items-center justify-center group-hover:scale-105 transition-transform duration-200 border border-gray-200">
                                <img src={ICONS.crear} className="w-6 h-6"/>
                            </div>
                        </button>

                        <button onClick={()=>setActiveTab('inbox')} className="flex flex-col items-center gap-1 w-14 cursor-pointer transition active:scale-90 opacity-50 hover:opacity-100 relative">
                            <img src={ICONS.bandeja} className="w-7 h-7 invert"/>
                            <span className="text-[10px] font-medium text-white">Bandeja</span>
                            {notifications.some(n => new Date().getTime() - new Date(n.createdAt).getTime() < 86400000) && (
                                <span className="absolute top-0 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border border-black"></span>
                            )}
                        </button>
                        <button onClick={()=>{setViewingProfile(null); setActiveTab('profile')}} className="flex flex-col items-center gap-1 w-14 cursor-pointer transition active:scale-90 opacity-50 hover:opacity-100">
                            <img src={ICONS.perfil} className="w-7 h-7 invert"/><span className="text-[10px] font-medium text-white">Perfil</span>
                        </button>
                    </div>

                    <UploadModal isOpen={showUpload} onClose={() => setShowUpload(false)} user={user} />
                    <ShareVideoModal isOpen={!!showShare} onClose={() => setShowShare(null)} videoId={showShare} user={user} chats={chats} />
                    
                    {activeChatId && <ChatScreen chatId={activeChatId} user={user} onClose={() => setActiveChatId(null)} videos={videos} />}
                    
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>